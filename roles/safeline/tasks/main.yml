---
# SafeLine WAF - –†–æ–ª—å SafeLine
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SafeLine WAF Community Edition

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Docker
  command: docker --version
  register: docker_check
  changed_when: false
  failed_when: docker_check.rc != 0
  tags:
    - safeline
    - prerequisites

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Docker Compose
  command: docker compose version
  register: docker_compose_check
  changed_when: false
  failed_when: docker_compose_check.rc != 0
  tags:
    - safeline
    - prerequisites

- name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ SafeLine
  file:
    path: "{{ safeline_directory }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  tags:
    - safeline
    - setup

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SafeLine
  stat:
    path: "{{ safeline_directory }}/compose.yaml"
  register: safeline_exists
  tags:
    - safeline
    - check

- name: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ SafeLine (–µ—Å–ª–∏ –µ—Å—Ç—å)
  command: docker compose -f compose.yaml down
  args:
    chdir: "{{ safeline_directory }}"
  ignore_errors: true
  tags:
    - safeline
    - cleanup

- name: –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  copy:
    src: "{{ safeline_directory }}/"
    dest: "{{ backup_directory }}/safeline-backup-{{ ansible_date_time.epoch }}/"
    remote_src: yes
  when: safeline_exists.stat.exists and backup_enabled | default(false)
  tags:
    - safeline
    - backup

- name: –ó–∞–≥—Ä—É–∑–∫–∞ docker-compose —Ñ–∞–π–ª–∞ SafeLine
  get_url:
    url: "https://raw.githubusercontent.com/chaitin/SafeLine/refs/tags/v{{ safeline_image_tag }}/compose.yaml"
    dest: "{{ safeline_directory }}/compose.yaml"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
    backup: yes
    timeout: 30
  register: compose_download
  retries: 3
  delay: 10
  tags:
    - safeline
    - download


# - name: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ compose.yaml —Å GitHub
#   get_url:
#     url: "https://raw.githubusercontent.com/chaitin/SafeLine/{{ safeline_image_tag }}/compose.yaml"
#     dest: "{{ safeline_directory }}/compose.yaml"
#     owner: "{{ target_user }}"
#     group: "{{ target_user }}"
#     mode: '0644'
#     backup: yes
#     timeout: 30
#   when: compose_download is failed
#   tags:
#     - safeline
#     - download
#     - alternative


- name: –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è SafeLine
  template:
    src: safeline.env.j2
    dest: "{{ safeline_directory }}/.env"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0600'
    backup: yes
  tags:
    - safeline
    - config

- name: –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –Ω–∞–ø—Ä—è–º—É—é (–µ—Å–ª–∏ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–∞)
  copy:
    dest: "{{ safeline_directory }}/.env"
    content: |
      # SafeLine WAF Environment Configuration
      SAFELINE_DIR={{ safeline_directory }}
      IMAGE_TAG={{ safeline_image_tag }}
      MGT_PORT={{ safeline_admin_port }}
      POSTGRES_PASSWORD={{ safeline_postgres_password }}
      SUBNET_PREFIX={{ safeline_subnet_prefix }}
      IMAGE_PREFIX={{ safeline_image_prefix }}
      ARCH_SUFFIX={{ safeline_arch_suffix }}
      RELEASE={{ safeline_release }}
      REGION={{ safeline_region }}
      
      # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      TZ={{ container_timezone | default(timezone) }}


- name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤ SafeLine
  file:
    path: "{{ safeline_directory }}/logs"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  tags:
    - safeline
    - logs

- name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö SafeLine
  file:
    path: "{{ safeline_directory }}/data"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'
  tags:
    - safeline
    - data

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –¥–ª—è SafeLine
  block:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π CPU (ssse3)
      shell: lscpu | grep -i ssse3
      register: cpu_check
      changed_when: false
      ignore_errors: true
      tags:
        - safeline
        - requirements

    - name: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö CPU
      debug:
        msg: "–í–ù–ò–ú–ê–ù–ò–ï: CPU –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç—Ä–µ–±—É–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ SSSE3"
      when: cpu_check.rc != 0
      tags:
        - safeline
        - requirements

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
      shell: df -h {{ safeline_directory }} | awk 'NR==2 {print $4}' | sed 's/G//'
      register: disk_space
      changed_when: false

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
      fail:
        msg: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 5GB, –¥–æ—Å—Ç—É–ø–Ω–æ: {{ disk_space.stdout }}G"
      when: disk_space.stdout|int < 5
      tags:
        - safeline
        - requirements

- name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–æ–≤ SafeLine Docker
  command: docker compose pull
  args:
    chdir: "{{ safeline_directory }}"
  register: pull_result
  retries: 3
  delay: 30
  tags:
    - safeline
    - pull

- name: –ó–∞–ø—É—Å–∫ SafeLine –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  command: docker compose up -d
  args:
    chdir: "{{ safeline_directory }}"
  register: startup_result
  tags:
    - safeline
    - start

- name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ SafeLine —Å–µ—Ä–≤–∏—Å–æ–≤ (admin)
  wait_for:
    port: "{{ safeline_admin_port }}"
    host: "{{ ansible_default_ipv4.address }}"
    delay: 10
    timeout: 300
    state: started
  tags:
    - safeline
    - verification

- name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–ø–æ—Ä—Ç–∞ SafeLine —á–µ—Ä–µ–∑ Nginx (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
  when: install_nginx | default(false)
  wait_for:
    port: "{{ safeline_web_port }}"
    host: "{{ ansible_default_ipv4.address }}"
    delay: 10
    timeout: 300
    state: started
  tags:
    - safeline
    - verification


- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ SafeLine
  command: docker compose ps
  args:
    chdir: "{{ safeline_directory }}"
  register: container_status
  changed_when: false
  tags:
    - safeline
    - status

- name: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  debug:
    var: container_status.stdout_lines
  tags:
    - safeline
    - status

- name: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  copy:
    content: |
      #!/bin/bash
      # –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ SafeLine

      echo "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ SafeLine..."
      echo "=========================================="

      if ! docker ps | grep -q safeline-mgt; then
          echo "–û—à–∏–±–∫–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä safeline-mgt –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: cd {{ safeline_directory }} && docker compose up -d"
          exit 1
      fi

      echo "–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:"
      docker exec safeline-mgt resetadmin

      echo ""
      echo "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:"
      echo "https://{{ ansible_default_ipv4.address }}:{{ safeline_admin_port }}"
      echo ""
      echo "–õ–æ–≥–∏–Ω: admin"
    dest: /usr/local/bin/safeline-password
    owner: root
    group: root
    mode: '0755'
  tags:
    - safeline
    - admin

- name: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SafeLine
  copy:
    content: |
      #!/bin/bash
      # –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SafeLine WAF

      SAFELINE_DIR="{{ safeline_directory }}"

      case "$1" in
         start)
            cd "$SAFELINE_DIR" && docker compose up -d
            ;;
         stop)
            cd "$SAFELINE_DIR" && docker compose down
            ;;
         restart)
            cd "$SAFELINE_DIR" && docker compose restart
            ;;
         status)
            cd "$SAFELINE_DIR" && docker compose ps
            ;;
         logs)
            cd "$SAFELINE_DIR" && docker compose logs -f
            ;;
         update)
            cd "$SAFELINE_DIR" && docker compose pull && docker compose up -d
            ;;
         backup)
            BACKUP_FILE="/tmp/safeline-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf "$BACKUP_FILE" -C "$(dirname $SAFELINE_DIR)" "$(basename $SAFELINE_DIR)"
            ;;
         *)
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {start|stop|restart|status|logs|update|backup}"
            exit 1
            ;;
      esac
    dest: /usr/local/bin/safeline-ctl
    owner: root
    group: root
    mode: '0755'
  tags:
    - safeline
    - management

- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ SafeLine –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
  cron:
    name: "SafeLine autostart"
    special_time: reboot
    job: "cd {{ safeline_directory }} && docker compose up -d"
    user: root
  when: safeline_autostart | default(false)
  tags:
    - safeline
    - autostart

- name: –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è SafeLine
  copy:
    content: |
      [Unit]
      Description=SafeLine WAF
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory={{ safeline_directory }}
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/safeline.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - enable safeline
  when: safeline_autostart | default(false)
  tags:
    - safeline
    - systemd

- name: –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  command: docker exec safeline-mgt resetadmin
  register: admin_password
  changed_when: false
  ignore_errors: true
  tags:
    - safeline
    - admin

- name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ
  copy:
    content: |
      SafeLine WAF - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ
      =====================================

      –î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: {{ ansible_date_time.iso8601 }}
      –•–æ—Å—Ç: {{ inventory_hostname }} ({{ ansible_default_ipv4.address }})
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ target_user }}

      –ü—É—Ç–∏:
      - –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {{ safeline_directory }}
      - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {{ safeline_directory }}/.env
      - Docker Compose: {{ safeline_directory }}/compose.yaml

      –ü–æ—Ä—Ç—ã:
      - HTTP: {{ safeline_web_port }}
      - HTTPS: {{ safeline_https_port }}
      - Admin Panel: {{ safeline_admin_port }}

      –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
      - safeline-ctl {start|stop|restart|status|logs|update|backup}
      - safeline-password (–ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞)

      –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
      https://{{ ansible_default_ipv4.address }}:{{ safeline_admin_port }}

      –õ–æ–≥–∏–Ω: admin
      {% if admin_password.stdout is defined %}
      –ü–∞—Ä–æ–ª—å: {{ admin_password.stdout }}
      {% else %}
      –ü–∞—Ä–æ–ª—å: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É 'safeline-password'
      {% endif %}

      –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
      - docker compose ps (–≤ {{ safeline_directory }})
      - docker compose logs -f (–≤ {{ safeline_directory }})
      - docker exec safeline-mgt resetadmin
    dest: "{{ safeline_directory }}/INSTALLATION_INFO.txt"
    mode: '0600'
  tags:
    - safeline
    - documentation

- name: –§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ SafeLine
  debug:
    msg: |
      =================================
      SafeLine WAF —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
      =================================

      üåê –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: https://{{ ansible_default_ipv4.address }}:{{ safeline_admin_port }}
      üë§ –õ–æ–≥–∏–Ω: admin
      üîë –ü–∞—Ä–æ–ª—å: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É 'safeline-password'

      üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {{ safeline_directory }}
      üê≥ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: safeline-ctl status
      üìã –õ–æ–≥–∏: safeline-ctl logs

      üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
      - safeline-ctl start|stop|restart|status|logs|update|backup
      - safeline-password (–ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å)

      üìä –ü–æ—Ä—Ç—ã:
      - HTTP: {{ safeline_web_port }}
      - HTTPS: {{ safeline_https_port }}
      - Admin: {{ safeline_admin_port }}

      ‚ö†Ô∏è  –í–∞–∂–Ω–æ: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞—â–∏—â–∞–µ–º—ã–µ —Å–∞–π—Ç—ã –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è!
  tags:
    - safeline
    - summary
