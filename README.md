# SafeLine WAF + VPS - Ansible Playbook

<img width="718" height="174" alt="image" src="https://github.com/user-attachments/assets/f036c8c1-1979-450c-bf80-3e3e882c1cd6" />

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

**Production-ready** Ansible playbook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è **SafeLine WAF Community Edition** –Ω–∞ VPS (Ubuntu/Debian) —Å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º. 

üéØ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è, —Ç–∞–∫ –∏ –¥–ª—è **localhost** (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Ç–æ–π –∂–µ –º–∞—à–∏–Ω–µ).

### üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker + Docker Compose** (–≤–µ—Ä—Å–∏—è 2.24.0+)
- ‚úÖ **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ SafeLine WAF** –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
- ‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ UFW + fail2ban** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
- ‚úÖ **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π reverse-proxy Nginx** —Å GeoIP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- ‚úÖ **–°–∏—Å—Ç–µ–º–Ω–æ–µ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** (kernel parameters, SSH hardening)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ swap** –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–¢–µ–≥–∏ –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞** –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ **–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- ‚úÖ **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- üè† **Localhost –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞ —Ç–æ–π –∂–µ –º–∞—à–∏–Ω–µ

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **Fail2ban –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å UFW (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ "Invalid position 1")
- **SSH —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ** —Å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º –ø–∞—Ä–æ–ª—å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **Kernel security parameters** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞—Ç–∞–∫
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞** –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø–æ IP
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤** —Å —Å–∂–∞—Ç–∏–µ–º

### üì¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –û–°

- ‚úÖ **Ubuntu**: 20.04 LTS, 22.04 LTS, 24.04 LTS
- ‚úÖ **Debian**: 10 (Buster), 11 (Bullseye), 12 (Bookworm)

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
safeline-ansible/
‚îú‚îÄ‚îÄ ansible.cfg                 # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Ansible
‚îú‚îÄ‚îÄ inventory.ini               # –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è localhost)
‚îú‚îÄ‚îÄ site.yml                    # –ì–ª–∞–≤–Ω—ã–π playbook —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
‚îú‚îÄ‚îÄ deploy.sh                   # –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
‚îú‚îÄ‚îÄ .gitignore                  # –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è Git
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îî‚îÄ‚îÄ all.yml                 # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (localhost –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
‚îú‚îÄ‚îÄ host_vars/                  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤
‚îî‚îÄ‚îÄ roles/
    ‚îú‚îÄ‚îÄ common/                 # –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml      # –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
    ‚îÇ   ‚îî‚îÄ‚îÄ handlers/main.yml   # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    ‚îú‚îÄ‚îÄ docker/                 # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker/Compose
    ‚îú‚îÄ‚îÄ firewall/               # UFW + fail2ban (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
    ‚îÇ   ‚îú‚îÄ‚îÄ tasks/main.yml
    ‚îÇ   ‚îú‚îÄ‚îÄ handlers/main.yml
    ‚îÇ   ‚îî‚îÄ‚îÄ templates/
    ‚îÇ       ‚îú‚îÄ‚îÄ ufw.conf.j2     # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è UFW
    ‚îÇ       ‚îî‚îÄ‚îÄ jail.local.j2   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è fail2ban
    ‚îú‚îÄ‚îÄ safeline/               # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SafeLine WAF
    ‚îî‚îÄ‚îÄ nginx/                  # Reverse-proxy (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### üì• 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone https://github.com/JedaiRussia/safeline-ansible.git
cd safeline-ansible

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ansible —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
sudo apt update && sudo apt install -y ansible
```

### üñ•Ô∏è 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è localhost (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ï—Å–ª–∏ –≤—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ SafeLine WAF **–Ω–∞ —Ç—É –∂–µ –º–∞—à–∏–Ω—É**, —Å –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ Ansible:

**inventory.ini —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è localhost:**
```ini
[safeline_servers]
localhost ansible_connection=local ansible_python_interpreter=/usr/bin/python3
```

**–ù–∞—Å—Ç—Ä–æ–π—Ç–µ admin_allowed_ips –≤ group_vars/all.yml:**
```yaml
admin_allowed_ips:
  - 127.0.0.1/32       # Localhost –¥–æ—Å—Ç—É–ø
  - ::1/128             # IPv6 localhost
  # - YOUR_EXTERNAL_IP/32  # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
```

### üåê 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

–ï—Å–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ –Ω–∞ **—É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä**:

```ini
# inventory.ini
[safeline_servers]
your-server.example.com ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/your-key.pem

[safeline_servers:vars]
ansible_python_interpreter=/usr/bin/python3
```

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `group_vars/all.yml`:
```yaml
admin_allowed_ips:
  - YOUR_REAL_IP/32     # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π IP!
  # –£–∑–Ω–∞—Ç—å —Å–≤–æ–π IP: curl ifconfig.me
```

### üîß 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
ansible-playbook site.yml --syntax-check

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (dry-run)
ansible-playbook site.yml --check

# –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
./deploy.sh

# –í—ã–±–æ—Ä–æ—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Ç–µ–≥–∏)
./deploy.sh common,docker,safeline
```

## ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `safeline_directory` | –ö–∞—Ç–∞–ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SafeLine | `/opt/safeline` |
| `safeline_admin_port` | –ü–æ—Ä—Ç –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (HTTPS) | `9443` |
| `admin_allowed_ips` | IP –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∫–µ | `[127.0.0.1/32, ::1/128]` ‚ö†Ô∏è |
| `install_nginx` | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Nginx reverse-proxy | `false` |
| `ufw_enabled` | –í–∫–ª—é—á–∏—Ç—å UFW firewall | `true` |
| `fail2ban_enabled` | –í–∫–ª—é—á–∏—Ç—å fail2ban | `true` |
| `backup_enabled` | –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ | `true` |
| `swap_file_size` | –†–∞–∑–º–µ—Ä swap —Ñ–∞–π–ª–∞ | `2G` |
| `timezone` | –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ | `Europe/Moscow` |
| `localhost_mode` | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è localhost | `true` |


üìã –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `target_user` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è SafeLine (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è localhost)
- `additional_packages` - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
- `max_open_files` - –õ–∏–º–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤ (65536)
- `kernel_parameters` - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- `fail2ban_bantime` - –í—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP (24h)
- `fail2ban_maxretry` - –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ (3)
- `ssh_hardening` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è SSH
- `disable_services` - –û—Ç–∫–ª—é—á–∞–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `enable_system_monitoring` - –°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `logrotate_configs` - –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- `backup_retention_days` - –•—Ä–∞–Ω–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ (30 –¥–Ω–µ–π)

### Localhost –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- `localhost_mode` - –†–µ–∂–∏–º localhost
- `single_node_deployment` - –û–¥–Ω–æ—É–∑–ª–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- `local_backup_path` - –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è –±—ç–∫–∞–ø–æ–≤



## üè∑Ô∏è –¢–µ–≥–∏ –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

| –¢–µ–≥ | –û–ø–∏—Å–∞–Ω–∏–µ | –í–∫–ª—é—á–∞–µ—Ç |
|-----|----------|----------|
| `common` | –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã | –ü–∞–∫–µ—Ç—ã, swap, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ª–∏–º–∏—Ç—ã |
| `docker` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker/Compose | Docker CE, Docker Compose 2.24.0+ |
| `firewall` | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞—â–∏—Ç—ã | UFW, fail2ban, –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ |
| `safeline` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SafeLine WAF | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —Å–∫—Ä–∏–ø—Ç—ã |
| `nginx` | Reverse-proxy | Nginx, GeoIP (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ) |

```bash
# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–≥–æ–≤
./deploy.sh common,docker          # –¢–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–∞ –∏ Docker
./deploy.sh firewall,safeline      # –¢–æ–ª—å–∫–æ –∑–∞—â–∏—Ç–∞ –∏ WAF
./deploy.sh nginx                  # –¢–æ–ª—å–∫–æ Nginx
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### ‚úÖ –°—Ç–∞—Ç—É—Å SafeLine

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
cd /opt/safeline && docker compose ps

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
cd /opt/safeline && docker compose logs -f

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
safeline-password
# –∏–ª–∏
sudo docker exec safeline-mgt resetadmin
```

### üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WAF

```bash
# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
safeline-ctl {start|stop|restart|status|logs|update|backup}

# –ü—Ä–∏–º–µ—Ä—ã
safeline-ctl status    # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
safeline-ctl logs      # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
safeline-ctl backup    # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
```

### üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
# –°—Ç–∞—Ç—É—Å fail2ban
sudo fail2ban-client status

# –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP
sudo fail2ban-client status sshd

# –ü—Ä–∞–≤–∏–ª–∞ UFW
sudo ufw status verbose

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
sudo journalctl -u fail2ban -f
```

## üñ•Ô∏è Localhost —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ localhost —Ä–µ–∂–∏–º–∞

- ‚ö° **–ë—ã—Å—Ç—Ä–µ–µ** - –Ω–µ—Ç SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ** - –Ω–µ—Ç —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞  
- üéØ **–ü—Ä–æ—â–µ** - –Ω–µ –Ω—É–∂–Ω—ã SSH –∫–ª—é—á–∏
- üíæ **–ú–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤** - –Ω–µ—Ç SSH overhead

### üè† –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ (localhost)

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
# –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
sudo docker exec safeline-mgt resetadmin

# –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
https://localhost:9443
https://127.0.0.1:9443
```

### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è localhost

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è localhost –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ:
- –î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ç–æ–ª—å–∫–æ —Å `127.0.0.1` –∏ `::1`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∏—Å—Ç–µ–º—ã
- –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤: `/home/$USER/safeline-backups`
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ UFW –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è loopback
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π whitelist localhost –≤ fail2ban

### üåê –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∏–∑–≤–Ω–µ, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ `group_vars/all.yml`:
```yaml
admin_allowed_ips:
  - 127.0.0.1/32
  - ::1/128
  - YOUR_EXTERNAL_IP/32    # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ
```

## üîß –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ email

–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ `group_vars/all.yml`:

```yaml
fail2ban_destemail: admin@yourdomain.com
fail2ban_sendername: 'Fail2Ban SafeLine Server'

notifications:
  enabled: true
  email:
    smtp_server: smtp.gmail.com
    smtp_port: 587
    username: notifications@yourdomain.com
    password: "{{ vault_smtp_password }}"
```

### üåê Nginx —Å GeoIP

```yaml
install_nginx: true
nginx_geoip_enabled: true
nginx_blocked_countries:
  - CN  # –ö–∏—Ç–∞–π
  - RU  # –†–æ—Å—Å–∏—è (–ø—Ä–∏–º–µ—Ä)
```

### üè¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞

–°–æ–∑–¥–∞–π—Ç–µ `host_vars/your-server.yml`:

```yaml
# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production —Å–µ—Ä–≤–µ—Ä–∞
admin_allowed_ips:
  - 203.0.113.5/32        # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π IP –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

fail2ban_bantime: '48h'   # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞
fail2ban_maxretry: 2

swap_file_size: '4G'      # –ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
```

## üõ†Ô∏è Troubleshooting

### ‚ùå –ü—Ä–æ–±–ª–µ–º—ã –¥–æ—Å—Ç—É–ø–∞

**–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–∞ –ø–æ—Ä—Ç—É 9443?**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à IP –≤—Ö–æ–¥–∏—Ç –≤ `admin_allowed_ips`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç –≤ UFW: `sudo ufw status`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: `docker compose ps`

```bash
# –î–ª—è localhost –ø—Ä–æ–≤–µ—Ä—å—Ç–µ
curl -k https://localhost:9443
curl -k https://127.0.0.1:9443
```

**–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è?**

```bash
cd /opt/safeline
docker compose logs -f
```

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤**

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- **CPU**: 1 core (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 2+)
- **RAM**: 1 GB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 4 GB)
- **–î–∏—Å–∫**: 5 GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: x86_64 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SSSE3 –∏–ª–∏ ARM64

### üö´ –ü—Ä–æ–±–ª–µ–º—ã —Å fail2ban

**Fail2ban –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å UFW**

–≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ playbook. –ï—Å–ª–∏ –≤—Å—ë –∂–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo fail2ban-client -vvv start
sudo tail -f /var/log/fail2ban.log
```

### üê≥ –ü—Ä–æ–±–ª–µ–º—ã —Å Docker

**Docker –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
sudo apt update
sudo apt-cache policy docker-ce

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo apt remove docker-ce docker-ce-cli containerd.io
./deploy.sh docker
```

### üÜò –ü—Ä–æ–±–ª–µ–º—ã Ansible

**"listen is not a valid attribute"**

–≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ - handlers –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã.

**–ü—Ä–æ–±–ª–µ–º—ã —Å localhost –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º**

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ inventory
grep -n "ansible_connection" inventory.ini

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ansible_connection=local
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### üìà –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏ SafeLine
sudo tail -f /opt/safeline/logs/*.log

# Fail2ban –ª–æ–≥–∏
sudo tail -f /var/log/fail2ban.log

# UFW –ª–æ–≥–∏
sudo tail -f /var/log/ufw.log

# Docker –ª–æ–≥–∏
sudo docker logs safeline-mgt -f
```

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
docker stats

# –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
htop
df -h
free -h
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SafeLine

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
safeline-ctl update

# –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
cd /opt/safeline
docker compose pull
docker compose up -d
```

### üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
safeline-ctl backup

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
# safeline-ctl restore /opt/backups/safeline-backup-YYYY-MM-DD.tar.gz
```

## üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSH –∫–ª—é—á–∏**, –æ—Ç–∫–ª—é—á–∏—Ç–µ –ø–∞—Ä–æ–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –¥–ª—è fail2ban
3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ** —Å–∏—Å—Ç–µ–º—É –∏ SafeLine
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
5. **–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

1. **–£–≤–µ–ª–∏—á—å—Ç–µ swap** –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –º–µ–Ω–µ–µ —á–µ–º 4GB RAM
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU, RAM, disk)
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ Docker** –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ production_optimizations
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSD** –¥–∏—Å–∫–∏ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### üîß –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

1. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥–∏** –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ host_vars
4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

## ü§ù –£—á–∞—Å—Ç–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

### üêõ –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

–°–æ–∑–¥–∞–π—Ç–µ issue —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º:
- –í–µ—Ä—Å–∏—è –û–° –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –†–µ–∂–∏–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (localhost/remote)
- –í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã —Å –æ—à–∏–±–∫–æ–π
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

–ú—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º:
- –ù–æ–≤—ã–µ —Ä–æ–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –£–ª—É—á—à–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- Localhost –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. —Ñ–∞–π–ª [LICENSE](LICENSE)

## ‚≠ê –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

- [SafeLine WAF](https://waf.chaitin.com/) –∑–∞ –æ—Ç–ª–∏—á–Ω—ã–π open-source WAF
- –°–æ–æ–±—â–µ—Å—Ç–≤—É Ansible –∑–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- –í—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç —É–ª—É—á—à–∞—Ç—å –ø—Ä–æ–µ–∫—Ç

**üõ°Ô∏è –ó–∞—â–∏—Ç–∏—Ç–µ —Å–≤–æ–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å SafeLine WAF + Ansible! üõ°Ô∏è**

### üöÄ –ë—ã—Å—Ç—Ä—ã–π localhost —Å—Ç–∞—Ä—Ç:
```bash
git clone https://github.com/JedaiRussia/safeline-ansible.git
cd safeline-ansible
./deploy.sh
# –î–æ—Å—Ç—É–ø: https://localhost:9443
```